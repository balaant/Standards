# Инфраструктура и развертывание

1. ОС Ubuntu 20.04
2. Мониторинг Prometheus + Grafana
3. Пайплайны развертывания CI в GitLab bmstu.codes
4. Контейнеры docker compose в настоящее время, Kubernetes в 2023
5. Ansible
6. Nginx
7. Для деплоя необходимо соблюдать правило: `1 репозиторий` - `1 контейнер` - `1 сервис`

### GitLab, пайплайны

- GitLab bmstu.codes, категория Кафедральных сервисов [ИУ5 / IU5 Infrastructure / Department Services] (https://bmstu.codes/iu5/infrastructure/department-services)
- Прямые commit в master запрещаются, все изменения проходят через запросы на слияние

- Пайплайны: подключение к проекту описано [тут](https://bmstu.codes/iu5/infrastructure/department-services/pipelines) 


### Деплой сервиса, nginx

1. Каждый проект должен содержать информацию по развертыванию- в настоящий момент это файл docker-compose.yml
2. В зависимости от типа развертывания необходимо подключить тот или иной [пайплайн](https://bmstu.codes/iu5/infrastructure/department-services/pipelines) 
3. Общий принцип: 
3.1. Создается запрос на слияние, который вызывает пайплайн для прогона тестов и линтера на ветке
3.2. После прохождения запроса на слияние запускается пайплайн для развертывания: 
 - на тестовом стенде (ml-iu5)
 - (вручную, после развертывания тестового стенда)- на боевом стенде (doc-iu5)
3.3 Можно указывать конфигурацию развертывания как общую, так и специфичную для стенда: 
- общая: фал docker-compose.yml в корне проекта
- от стенда: папки dev/docker-compose.yml и prod/docker-compose.yml. Эта опция имеет приоритет и перезапишет общую конфигурацию
